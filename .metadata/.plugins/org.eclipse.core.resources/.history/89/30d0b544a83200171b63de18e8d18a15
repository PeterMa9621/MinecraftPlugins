package prefixManager;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;
import java.text.SimpleDateFormat;

import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.inventory.InventoryOpenEvent;
import org.bukkit.event.player.AsyncPlayerChatEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.inventory.ItemStack;

import net.milkbowl.vault.economy.Economy;

public class PrefixManagerListener implements Listener
{
	private PrefixManager plugin;
	

	public PrefixManagerListener(PrefixManager plugin)
	{
		this.plugin=plugin;
	}
	
	@EventHandler
	public void onPlayerJoin(PlayerJoinEvent event)
    {
		loadConfig(event.getPlayer());
		return;
    }
	
	public void loadConfig(Player p)
	{
		File file=new File(plugin.getDataFolder(),"/Data/"+p.getName()+".yml");
		FileConfiguration config;
		String myPrefix = null;
		if(!file.exists())
		{
			config = plugin.load(file);
			try {
				config.save(file);
			} catch (IOException e) {
				e.printStackTrace();
			}
			return;
		}

	}
	
	@EventHandler
	private void onPlayerClickMyPrefix(InventoryClickEvent event)
	{
		if(!event.getInventory().getTitle().equalsIgnoreCase("§5我的称号"))
		{
			return;
		}
		
		if(event.getRawSlot()<plugin.prefixList.size() && event.getRawSlot()>=0)
		{
			Player p = (Player)event.getWhoClicked();
			
			ArrayList<String> myPrefix = new ArrayList<String>();
			File file=new File(plugin.getDataFolder(),"/Data/"+p.getName()+".yml");
			FileConfiguration config;
			config = plugin.load(file);
			if(config.getString("MyPrefix")!=null)
			{
				for(String prefix:config.getString("MyPrefix").split("%%"))
				{
					myPrefix.add(prefix);
				}
			}
			
			event.setCancelled(true);
			//if(钱够或者点券够)then获得称号
			if(myPrefix.contains(plugin.prefixList.get(event.getRawSlot())))
			{
				p.sendMessage("§a[称号系统]§3你已经拥有这个称号了。");
				return;
			}

			String prefix = config.getString("MyPrefix");
			if(prefix==null)
				prefix = plugin.prefixList.get(event.getRawSlot());
			else
				prefix = prefix + "%%" + plugin.prefixList.get(event.getRawSlot());
			config.set("MyPrefix", prefix);
			try {
				config.save(file);
			} catch (IOException e) {
				e.printStackTrace();
			}
			p.openInventory(plugin.initShop(p));
			p.sendMessage("§a[称号系统]§3购买成功。");
		}
	}
	
	@EventHandler
	private void onPlayerClickInventory(InventoryClickEvent event)
	{
		if(!event.getInventory().getTitle().equalsIgnoreCase("§5称号商店"))
		{
			return;
		}
		
		if(event.getRawSlot()<plugin.prefixList.size() && event.getRawSlot()>=0)
		{
			Player p = (Player)event.getWhoClicked();
			
			ArrayList<String> myPrefix = new ArrayList<String>();
			File file=new File(plugin.getDataFolder(),"/Data/"+p.getName()+".yml");
			FileConfiguration config;
			config = plugin.load(file);
			if(config.getString("MyPrefix")!=null)
			{
				for(String prefix:config.getString("MyPrefix").split("%%"))
				{
					myPrefix.add(prefix);
				}
			}
			
			event.setCancelled(true);
			//if(钱够或者点券够)then获得称号
			if(myPrefix.contains(plugin.prefixList.get(event.getRawSlot())))
			{
				p.sendMessage("§a[称号系统]§3你已经拥有这个称号了。");
				return;
			}

			String prefix = config.getString("MyPrefix");
			if(prefix==null)
				prefix = plugin.prefixList.get(event.getRawSlot());
			else
				prefix = prefix + "%%" + plugin.prefixList.get(event.getRawSlot());
			config.set("MyPrefix", prefix);
			try {
				config.save(file);
			} catch (IOException e) {
				e.printStackTrace();
			}
			p.openInventory(plugin.initShop(p));
			p.sendMessage("§a[称号系统]§3购买成功。");
		}
	}
	

}
