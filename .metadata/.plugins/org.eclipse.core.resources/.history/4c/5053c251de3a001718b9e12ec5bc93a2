package personalQuest;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;

import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerQuitEvent;

public class PersonalQuestListener implements Listener
{
	private PersonalQuest plugin;

	public PersonalQuestListener(PersonalQuest plugin)
	{
		this.plugin=plugin;
	}
	
	@EventHandler
	public void onPlayerJoin(PlayerJoinEvent event)
    {
		loadQuestsConfig(event.getPlayer());
		return;
    }
	
	@EventHandler
	public void onPlayerQuit(PlayerQuitEvent event)
    {
		saveQuestsConfig(event.getPlayer());
		return;
    }
	
	public void loadQuestsConfig(Player p)
	{
		File file=new File(plugin.getDataFolder(),"/Data/quests.yml");
		FileConfiguration config;
		if (!file.exists())
		{
			config = plugin.load(file);
			
			try 
			{
				config.save(file);
			} 
			catch (IOException e) 
			{
				e.printStackTrace();
			}
			loadQuestsConfig(p);
			return;
		}
		config = plugin.load(file);
		if(!config.contains(p.getName()))
			return;
		for(int i=1; config.contains(p.getName()+i); i++)
		{
			plugin.quests.get(p.getName()).clear();
			ArrayList<String> everyQuest = new ArrayList<String>();
			everyQuest.add(config.getString(p.getName()+"."+i+".QuestType"));
			everyQuest.add(config.getString(p.getName()+"."+i+".QuestName"));
			everyQuest.add(config.getString(p.getName()+"."+i+".QuestContent"));
			plugin.quests.get(p.getName()).add(everyQuest);
		}
		
	}
	
	public void saveQuestsConfig(Player p)
	{
		File file=new File(plugin.getDataFolder(),"/Data/quests.yml");
		FileConfiguration config;
		config = plugin.load(file);
		if(!plugin.quests.containsKey(p.getName()))
			return;
		int number = 1;
		for(ArrayList<String> everyQuest:plugin.quests.get(p.getName()))
		{
			config.set(p.getName()+"."+number+".QuestType", everyQuest.get(0));
			config.set(p.getName()+"."+number+".QuestName", everyQuest.get(1));
			config.set(p.getName()+"."+number+".QuestContent", everyQuest.get(2));
			number += 1;
		}
	}
	
	@EventHandler
	public void onPlayerClickGUI(InventoryClickEvent event)
    {
		if(event.getInventory().getTitle().equalsIgnoreCase("§5任务系统"))
		{
			event.setCancelled(true);
			Player p = (Player)event.getWhoClicked();
			if(event.getRawSlot()==2)
			{
				p.openInventory(plugin.initQuestGUI(p));
				return;
			}
		}
		
		if(event.getInventory().getTitle().equalsIgnoreCase("§5任务平台"))
		{
			event.setCancelled(true);
			Player p = (Player)event.getWhoClicked();
			if(event.getRawSlot()==49)
			{
				p.openInventory(plugin.initAdd(p));
				return;
			}
		}
		
		if(event.getInventory().getTitle().equalsIgnoreCase("§5发布任务"))
		{
			event.setCancelled(true);
			Player p = (Player)event.getWhoClicked();
			if(event.getRawSlot()==2)
			{
				p.sendMessage("§a[发布物品需求任务]§e 请输入任务名称:");
				
				return;
			}
		}
		
		return;
    }
}
